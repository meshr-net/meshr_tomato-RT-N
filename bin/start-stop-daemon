#!/bin/sh
#ex. start-stop-daemon start "" update
set -x
[ -z $meshr ] && cd `dirname $0`/.. && meshr=`pwd`
setsid --help > /dev/null || alias setsid=
start(){
  # $meshr/bin/failsafe.sh ?
  for n in $names; do
     #[ ! -f $meshr/var/run/$n.pid ] && 
     #( nohup $@ && echo $!>$meshr/var/run/$(basename $n).pid ) &
     cmd="$@"
     setsid nohup /bin/sh -c "$cmd" > $meshr/tmp/nohup.out 2>&1 & #>/dev/null 2>&1 &
     echo $!>$meshr/var/run/$(basename $n).pid 
  done
}
stop(){
  echo $names
  for n in $names; do
    name=$(basename $n)
    ( cat $meshr/var/run/$name.pid | grep .. || ps | grep "$n" | grep -v "grep\|$$" | awk '{print $1}' | tr '\n' ' ' > $meshr/var/run/$name.pid ) && (
      pid=`cat $meshr/var/run/$name.pid`
      [ -n "$pid" ] && kill -s TERM -$pid || kill -9 $pid
      rm $meshr/var/run/$name.pid
      #mv -f $meshr/var/run/$name.pid $meshr/var/run/$name.pid.tmp
    )
  done
}
action=$1
a2=$2
names=$2
[ "$a2" == "" ] && {
  [ ! "$3" == "conn" ] && names="$names $meshr/lucid.bat"
  #[ ! "$3" == "update" ] && [ ! $3 == conn ] && names="$names $meshr/meshr-watchdog"
  names="$names $meshr/usr/sbin/olsrd $meshr/meshr-splash.bat"
  [ $action == stop ] && {
    names="$names $meshr/bin/DNS2SOCKS $meshr/bin/badvpn-tun2socks $meshr/bin/tor dnsmasq"
    $meshr/lib/setip.bat $meshr/var/run/wifi.txt #> $meshr/tmp/setip.log
    cp $meshr/var/run/wifi.txt $meshr/var/run/wifi2.txt
    rm $meshr/var/run/wifi.txt $meshr/var/run/wifi-formed.txt
    . $meshr/etc/wifi.txt
    $meshr/bin/wlan $guid dc
  }
}
shift 1
case $action in
stop)
  stop $@
  ;;
start)
   stop $@
   start $@
  ;;
restart)
   stop $@
   start $@
  ;; 
esac
