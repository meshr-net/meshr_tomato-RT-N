#!/bin/sh
#ex. start-stop-daemon start "" update
set -x
start(){
  # $meshr/bin/failsafe.sh ?
  for n in $names; do
     #[ ! -f $meshr/var/run/$n.pid ] && 
     #( nohup $@ && echo $!>$meshr/var/run/$n.pid ) &
     nohup /bin/sh -c $@ >/dev/null 2>&1 &
     echo $!>$meshr/var/run/$n.pid 
  done
}
stop(){
  for n in $names; do
    [ -f $meshr/var/run/$n.pid ] && {
      kill -9 `cat $meshr/var/run/$n.pid`
      rm $meshr/var/run/$n.pid
    }  
  done
}
action=$1
name=$(basename $2)
names=$name
[ $2 == "" ] && {
  [ ! $3 == conn ] && names=$names meshr
  #[ ! $3 == update ] && [ ! $3 == conn ] && names=$names meshr-watchdog
  names=$names olsrd meshr-splash
  [ $action == stop ] && {
    names=$names DualServer DNS2SOCKS badvpn-tun2socks
    . $meshr/lib/setip.bat $meshr/var/run/wifi.txt #> $meshr/tmp/setip.log
    cp $meshr/var/run/wifi.txt $meshr/var/run/wifi2.txt
    rm $meshr/var/run/wifi.txt $meshr/var/run/wifi-formed.txt
  }
}
shift 1
case $action in
stop)
  stop $@
  ;;
start)
   stop $@
   start $@
  ;;
restart)
   stop $@
   start $@
  ;; 
esac
